import{dirname}from'path';import{fileURLToPath}from'url';import*as _0x50069e from'fs';import*as _0x179e39 from'path';import*as _0x4e79f8 from'crypto';import{ffmpeg}from'./converter.js';import _0x3fb475 from'fluent-ffmpeg';import{spawn}from'child_process';import _0x31dccd from'./uploadFile.js';import _0x17055d from'./uploadImage.js';import{fileTypeFromBuffer}from'file-type';import _0x4d08a6 from'node-webpmux';import _0xdf7154 from'node-fetch';const __dirname=dirname(fileURLToPath(import.meta['url'])),tmp=_0x179e39['join'](__dirname,'../tmp');function sticker2(_0x565ff0,_0x17b041){return new Promise(async(_0x58e991,_0x2fa05b)=>{try{if(_0x17b041){const _0x51b973=await _0xdf7154(_0x17b041);if(_0x51b973['status']!==0xc8)throw await _0x51b973['text']();_0x565ff0=await _0x51b973['buffer']();}const _0x2a53d3=_0x179e39['join'](tmp,+new Date()+'.jpeg');await _0x50069e['promises']['writeFile'](_0x2a53d3,_0x565ff0);const _0xebd949=spawn('ffmpeg',['-y','-i',_0x2a53d3,'-vf','scale=512:512:flags=lanczos:force_original_aspect_ratio=decrease,format=rgba,pad=512:512:(ow-iw)/2:(oh-ih)/2:color=#00000000,setsar=1','-f','png','-']);_0xebd949['on']('error',_0x2fa05b),_0xebd949['on']('close',async()=>{await _0x50069e['promises']['unlink'](_0x2a53d3);});const _0x4ea96d=[],[_0x341b5f,..._0x5a5f0c]=[...module['exports']['support']['gm']?['gm']:module['exports']['magick']?['magick']:[],'convert','png:-','webp:-'],_0x23131b=spawn(_0x341b5f,_0x5a5f0c);_0x23131b['on']('error',_0x2b0d7b=>conn['reply'](m['chat'],util['format'](_0x2b0d7b),m)),_0x23131b['stdout']['on']('data',_0x39da12=>_0x4ea96d['push'](_0x39da12)),_0xebd949['stdout']['pipe'](_0x23131b['stdin']),_0x23131b['on']('exit',()=>{_0x58e991(Buffer['concat'](_0x4ea96d));});}catch(_0x15cc91){_0x2fa05b(_0x15cc91);}});}async function sticker3(_0xd227a0,_0xb61752,_0x2a10a0,_0x30d8e7){_0xb61752=_0xb61752?_0xb61752:await _0x31dccd(_0xd227a0);const _0x4af97b=await _0xdf7154('https://api.xteam.xyz/sticker/wm?'+new URLSearchParams(Object['entries']({'url':_0xb61752,'packname':_0x2a10a0,'author':_0x30d8e7})));return await _0x4af97b['buffer']();}async function sticker4(_0x4fcd46,_0x46e88a){if(_0x46e88a){const _0x3e5080=await _0xdf7154(_0x46e88a);if(_0x3e5080['status']!==0xc8)throw await _0x3e5080['text']();_0x4fcd46=await _0x3e5080['buffer']();}return await ffmpeg(_0x4fcd46,['-vf','scale=512:512:flags=lanczos:force_original_aspect_ratio=decrease,format=rgba,pad=512:512:(ow-iw)/2:(oh-ih)/2:color=#00000000,setsar=1'],'jpeg','webp');}async function sticker5(_0x534b66,_0x49ed5e,_0xa1f941,_0x2cd58e,_0x54474d=[''],_0x2eddea={}){const {Sticker:_0x155e79}=await import('wa-sticker-formatter'),_0x176a94={'type':'default','pack':_0xa1f941,'author':_0x2cd58e,'categories':_0x54474d,..._0x2eddea};return new _0x155e79(_0x534b66?_0x534b66:_0x49ed5e,_0x176a94)['toBuffer']();}function sticker6(_0x247294,_0x4bf693){return new Promise(async(_0x1847a2,_0x30ad81)=>{if(_0x4bf693){const _0x395c96=await _0xdf7154(_0x4bf693);if(_0x395c96['status']!==0xc8)throw await _0x395c96['text']();_0x247294=await _0x395c96['buffer']();}const _0x323f50=await fileTypeFromBuffer(_0x247294)||{'mime':'application/octet-stream','ext':'bin'};if(_0x323f50['ext']=='bin')_0x30ad81(_0x247294);const _0x3ebd4e=_0x179e39['join'](__dirname,'../tmp/'+ +new Date()+'.'+_0x323f50['ext']),_0x33a9ff=_0x179e39['join'](_0x3ebd4e+'.webp');await _0x50069e['promises']['writeFile'](_0x3ebd4e,_0x247294);const _0x2e51f4=/video/i['test'](_0x323f50['mime'])?_0x3fb475(_0x3ebd4e)['inputFormat'](_0x323f50['ext']):_0x3fb475(_0x3ebd4e)['input'](_0x3ebd4e);_0x2e51f4['on']('error',function(_0x210b74){console['error'](_0x210b74),_0x50069e['promises']['unlink'](_0x3ebd4e),_0x30ad81(_0x247294);})['on']('end',async function(){_0x50069e['promises']['unlink'](_0x3ebd4e),_0x1847a2(await _0x50069e['promises']['readFile'](_0x33a9ff));})['addOutputOptions'](['-vcodec','libwebp','-vf','scale=\x27min(320,iw)\x27:min\x27(320,ih)\x27:force_original_aspect_ratio=decrease,fps=15,\x20pad=320:320:-1:-1:color=white@0.0,\x20split\x20[a][b];\x20[a]\x20palettegen=reserve_transparent=on:transparency_color=ffffff\x20[p];\x20[b][p]\x20paletteuse'])['toFormat']('webp')['save'](_0x33a9ff);});}async function addExif(_0x1a20cc,_0x40c702,_0x18a96f,_0x299b90=[''],_0x59d85f={}){const _0x5fc448=new _0x4d08a6['Image'](),_0x1a855c=_0x4e79f8['randomBytes'](0x20)['toString']('hex'),_0x54dfbd={'sticker-pack-id':_0x1a855c,'sticker-pack-name':_0x40c702,'sticker-pack-publisher':_0x18a96f,'emojis':_0x299b90,..._0x59d85f},_0x583407=Buffer['from']([0x49,0x49,0x2a,0x0,0x8,0x0,0x0,0x0,0x1,0x0,0x41,0x57,0x7,0x0,0x0,0x0,0x0,0x0,0x16,0x0,0x0,0x0]),_0x54718d=Buffer['from'](JSON['stringify'](_0x54dfbd),'utf8'),_0xd1a9b6=Buffer['concat']([_0x583407,_0x54718d]);return _0xd1a9b6['writeUIntLE'](_0x54718d['length'],0xe,0x4),await _0x5fc448['load'](_0x1a20cc),_0x5fc448['exif']=_0xd1a9b6,await _0x5fc448['save'](null);}async function sticker(_0x58875d,_0x45b9d2,..._0x18ef4d){let _0x18f37b,_0x2c7b27;for(const _0x37c6aa of[sticker3,global['support']['ffmpeg']&&sticker6,sticker5,global['support']['ffmpeg']&&global['support']['ffmpegWebp']&&sticker4,global['support']['ffmpeg']&&(global['support']['convert']||global['support']['magick']||global['support']['gm'])&&sticker2]['filter'](_0x58587d=>_0x58587d)){try{_0x2c7b27=await _0x37c6aa(_0x58875d,_0x45b9d2,..._0x18ef4d);if(_0x2c7b27['includes']('html'))continue;if(_0x2c7b27['includes']('WEBP'))try{return await addExif(_0x2c7b27,..._0x18ef4d);}catch(_0x51c0c4){return console['error'](_0x51c0c4),_0x2c7b27;}throw _0x2c7b27['toString']();}catch(_0x5d39b2){_0x18f37b=_0x5d39b2;continue;}}return console['error'](_0x18f37b),_0x18f37b;}const support={'ffmpeg':!![],'ffprobe':!![],'ffmpegWebp':!![],'convert':!![],'magick':![],'gm':![],'find':![]};export{sticker,sticker2,sticker3,sticker4,sticker6,addExif,support};